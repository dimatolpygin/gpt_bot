<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Studio</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #070707;
      --bg-soft: #101010;
      --panel: #121212;
      --line: #2a2a2a;
      --muted: #a5a5a5;
      --text: #f5f5f5;
      --danger: #f87171;
      --ok: #86efac;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      min-height: 100%;
      font-family: 'Manrope', sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at -10% -10%, #2f2f2f 0%, transparent 55%),
        radial-gradient(900px 600px at 120% 0%, #1e1e1e 0%, transparent 62%),
        linear-gradient(180deg, #060606 0%, #0b0b0b 100%);
    }
    .app {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 14px;
      min-height: 100dvh;
      padding: 14px;
    }
    .panel {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      backdrop-filter: blur(8px);
      box-shadow: 0 20px 40px rgba(0,0,0,.45);
    }
    .sidebar {
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
    }
    .brand {
      border-bottom: 1px solid #1f1f1f;
      padding-bottom: 10px;
    }
    .brand h1 {
      margin: 0;
      font: 700 19px 'Space Grotesk', sans-serif;
    }
    .brand p {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 12px;
    }
    .section-nav {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .section-btn {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 9px 11px;
      background: linear-gradient(180deg, #161616 0%, #101010 100%);
      color: var(--text);
      text-align: left;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
    }
    .section-btn.active {
      background: linear-gradient(180deg, #ffffff 0%, #dbdbdb 100%);
      color: #101010;
      border-color: #efefef;
    }
    .list {
      border: 1px solid #1f1f1f;
      border-radius: 10px;
      overflow: auto;
      max-height: calc(100dvh - 370px);
      min-height: 180px;
      background: #0e0e0e;
    }
    .list-item {
      border-bottom: 1px solid #1d1d1d;
      padding: 9px 10px;
      font-size: 12px;
      cursor: pointer;
      word-break: break-word;
    }
    .list-item:last-child { border-bottom: 0; }
    .list-item:hover { background: #171717; }
    .list-item.active { background: #ffffff; color: #101010; font-weight: 800; }
    .pager {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .main {
      display: flex;
      flex-direction: column;
      min-width: 0;
      padding: 16px;
      gap: 12px;
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid #1f1f1f;
      padding-bottom: 10px;
    }
    .toolbar h2 {
      margin: 0;
      font: 700 20px 'Space Grotesk', sans-serif;
    }
    .toolbar p {
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted);
    }
    .status {
      font-size: 12px;
      color: var(--muted);
      max-width: 45%;
      text-align: right;
    }
    .editor {
      border: 1px solid #1f1f1f;
      border-radius: 12px;
      background: linear-gradient(180deg, #111111 0%, #0b0b0b 100%);
      padding: 14px;
      min-height: 340px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .field { margin-bottom: 10px; }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 11px;
      color: #9a9a9a;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .07em;
    }
    input, textarea, select {
      width: 100%;
      border: 1px solid #2e2e2e;
      border-radius: 10px;
      background: #0a0a0a;
      color: var(--text);
      padding: 9px 10px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #fff;
      box-shadow: 0 0 0 3px rgba(255,255,255,.08);
    }
    textarea { min-height: 210px; resize: vertical; }
    .btn {
      border: 0;
      border-radius: 10px;
      background: linear-gradient(180deg, #fff 0%, #dbdbdb 100%);
      color: #101010;
      padding: 9px 13px;
      font: 700 13px 'Space Grotesk', sans-serif;
      cursor: pointer;
      margin-right: 8px;
      margin-top: 8px;
    }
    .btn.alt {
      background: linear-gradient(180deg, #1d1d1d 0%, #151515 100%);
      border: 1px solid #2c2c2c;
      color: var(--text);
    }
    .btn.danger {
      background: linear-gradient(180deg, #fca5a5 0%, #ef4444 100%);
      color: #1c0101;
    }
    .note {
      color: #8f8f8f;
      font-size: 12px;
      line-height: 1.45;
      margin: 0;
    }
    .table-wrap {
      border: 1px solid #1f1f1f;
      border-radius: 10px;
      overflow: auto;
      margin-top: 10px;
      max-height: 420px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 720px;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid #1f1f1f;
      padding: 8px 9px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      position: sticky;
      top: 0;
      background: #121212;
      color: #d6d6d6;
      font-weight: 800;
      z-index: 1;
    }
    .drag-list {
      list-style: none;
      margin: 10px 0 0;
      padding: 0;
      border: 1px solid #1f1f1f;
      border-radius: 10px;
      overflow: hidden;
    }
    .drag-item {
      padding: 9px 10px;
      border-bottom: 1px solid #1f1f1f;
      background: #0f0f0f;
      cursor: grab;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
    }
    .drag-item:last-child { border-bottom: 0; }
    .drag-item.dragging { opacity: .45; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; padding: 10px; }
      .status { max-width: 100%; text-align: left; }
      .toolbar { flex-direction: column; }
      .grid { grid-template-columns: 1fr; }
      .list { max-height: 210px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel sidebar">
      <div class="brand">
        <h1>Admin Studio</h1>
        <p>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º</p>
      </div>

      <nav class="section-nav" id="sectionNav"></nav>

      <div class="field" style="margin-top:6px;">
        <label>–ü–æ–∏—Å–∫ / —Ñ–∏–ª—å—Ç—Ä</label>
        <input id="queryInput" placeholder="id, username, key, —Å—Ç–∞—Ç—É—Å..." />
      </div>

      <div class="list" id="list"></div>
      <div class="pager">
        <button class="btn alt" id="prevBtn">–ù–∞–∑–∞–¥</button>
        <button class="btn alt" id="nextBtn">–í–ø–µ—Ä—ë–¥</button>
      </div>
    </aside>

    <main class="panel main">
      <div class="toolbar">
        <div>
          <h2 id="sectionTitle">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª</h2>
          <p id="sectionSubtitle">–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram WebApp.</p>
        </div>
        <div class="status" id="status"></div>
      </div>
      <div class="editor" id="editor"></div>
    </main>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) tg.expand();

    const initData = tg?.initData || '';
    const hasInitData = Boolean(initData);

    const SECTIONS = [
      { id: 'content', title: 'üìù –ö–æ–Ω—Ç–µ–Ω—Ç –±–æ—Ç–∞', subtitle: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ bot_content' },
      { id: 'prices', title: 'üí∞ –¶–µ–Ω—ã —Ç–æ–∫–µ–Ω–æ–≤', subtitle: 'token_prices: tokens + active' },
      { id: 'tariffs', title: 'üì¶ –¢–∞—Ä–∏—Ñ—ã', subtitle: 'bot_tariffs + —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞' },
      { id: 'users', title: 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', subtitle: '–ü–æ–∏—Å–∫, –±–∞–Ω, —Å–±—Ä–æ—Å, –æ—á–∏—Å—Ç–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤' },
      { id: 'tokens', title: 'ü™ô –û–ø–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤', subtitle: '–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ + –∏—Å—Ç–æ—Ä–∏—è' },
      { id: 'referrals', title: 'üë• –†–µ—Ñ–µ—Ä–∞–ª—ã', subtitle: '–¢–æ–ø –∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é' },
      { id: 'purchases', title: 'üßæ –ü–æ–∫—É–ø–∫–∏', subtitle: '–ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏' },
      { id: 'admins', title: 'üõ° –ê–¥–º–∏–Ω—ã', subtitle: '–†–æ–ª–∏ owner/moderator' },
      { id: 'audit', title: 'üìú –ê—É–¥–∏—Ç', subtitle: '–õ–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–æ–≤' },
    ];

    const state = {
      section: null,
      items: [],
      selectedKey: null,
      page: 0,
      limit: 30,
      query: '',
      cache: {},
    };

    const sectionNav = document.getElementById('sectionNav');
    const queryInput = document.getElementById('queryInput');
    const listEl = document.getElementById('list');
    const editorEl = document.getElementById('editor');
    const titleEl = document.getElementById('sectionTitle');
    const subtitleEl = document.getElementById('sectionSubtitle');
    const statusEl = document.getElementById('status');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    const setStatus = (msg, ok = true) => {
      statusEl.textContent = msg || '';
      statusEl.style.color = ok ? '#a5a5a5' : '#f87171';
      if (msg) setTimeout(() => { statusEl.textContent = ''; }, 3400);
    };

    const ensureInitData = () => {
      if (!hasInitData) throw new Error('–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ Telegram WebApp.');
      return initData;
    };

    const apiFetch = async (path, payload = {}) => {
      const res = await fetch(path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...payload, initData: ensureInitData() }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.ok === false) {
        throw new Error(data.error || data.message || `HTTP ${res.status}`);
      }
      return data;
    };

    const fmtDate = (v) => v ? new Date(v).toLocaleString('ru-RU') : '-';

    const buildNav = () => {
      sectionNav.innerHTML = '';
      SECTIONS.forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'section-btn' + (state.section === s.id ? ' active' : '');
        btn.textContent = s.title;
        btn.onclick = () => selectSection(s.id);
        sectionNav.appendChild(btn);
      });
    };

    const selectSection = async (sectionId) => {
      state.section = sectionId;
      state.page = 0;
      state.selectedKey = null;
      state.cache = {};
      const meta = SECTIONS.find(x => x.id === sectionId);
      titleEl.textContent = meta?.title || '–†–∞–∑–¥–µ–ª';
      subtitleEl.textContent = meta?.subtitle || '';
      buildNav();
      await loadSection();
    };

    const renderList = () => {
      listEl.innerHTML = '';
      if (!state.items.length) {
        listEl.innerHTML = '<div class="list-item">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
        return;
      }

      state.items.forEach(item => {
        const el = document.createElement('div');
        el.className = 'list-item' + (item._key === state.selectedKey ? ' active' : '');
        el.textContent = item._label;
        el.onclick = () => {
          state.selectedKey = item._key;
          renderList();
          renderEditor();
        };
        listEl.appendChild(el);
      });
    };

    const renderTable = (columns, rows) => {
      if (!rows.length) return '<p class="note">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p>';
      const head = columns.map(c => `<th>${c.label}</th>`).join('');
      const body = rows.map(row => {
        const tds = columns.map(c => `<td>${c.render ? c.render(row) : (row[c.key] ?? '')}</td>`).join('');
        return `<tr>${tds}</tr>`;
      }).join('');
      return `<div class="table-wrap"><table><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table></div>`;
    };

    const renderEditor = () => {
      const item = state.items.find(x => x._key === state.selectedKey);
      if (!item) {
        editorEl.innerHTML = '<p class="note">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å —Å–ª–µ–≤–∞.</p>';
        return;
      }

      if (state.section === 'content') {
        editorEl.innerHTML = `
          <div class="field"><label>key</label><input disabled value="${item.key}" /></div>
          <div class="field"><label>label</label><input disabled value="${item.label || ''}" /></div>
          <div class="field"><label>text</label><textarea id="contentText">${item.text || ''}</textarea></div>
          <button class="btn" id="saveContentBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        `;
        document.getElementById('saveContentBtn').onclick = async () => {
          try {
            const text = document.getElementById('contentText').value;
            await apiFetch('/api/admin/content/update', { key: item.key, text });
            item.text = text;
            setStatus('–ö–æ–Ω—Ç–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω');
          } catch (e) { setStatus(e.message, false); }
        };
        return;
      }

      if (state.section === 'prices') {
        editorEl.innerHTML = `
          <div class="field"><label>action_key</label><input disabled value="${item.action_key}" /></div>
          <div class="field"><label>label</label><input disabled value="${item.label || ''}" /></div>
          <div class="grid">
            <div class="field"><label>tokens</label><input type="number" id="priceTokens" value="${item.tokens}" /></div>
            <div class="field"><label>active</label><select id="priceActive"><option value="1" ${item.active ? 'selected' : ''}>–í–∫–ª—é—á–µ–Ω–æ</option><option value="0" ${!item.active ? 'selected' : ''}>–í—ã–∫–ª—é—á–µ–Ω–æ</option></select></div>
          </div>
          <button class="btn" id="savePriceBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        `;
        document.getElementById('savePriceBtn').onclick = async () => {
          try {
            const tokens = parseInt(document.getElementById('priceTokens').value, 10) || 1;
            const active = document.getElementById('priceActive').value === '1';
            const data = await apiFetch('/api/admin/prices/update', { actionKey: item.action_key, tokens, active });
            Object.assign(item, data.row || {});
            renderList();
            setStatus('–¶–µ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
          } catch (e) { setStatus(e.message, false); }
        };
        return;
      }

      if (state.section === 'tariffs') {
        const listHtml = state.items.map(x =>
          `<li class="drag-item" draggable="true" data-id="${x.id}"><span>${x.name}</span><span class="mono">#${x.id}</span></li>`
        ).join('');

        editorEl.innerHTML = `
          <div class="grid">
            <div>
              <div class="field"><label>id</label><input disabled value="${item.id}" /></div>
              <div class="field"><label>name</label><input id="tariffName" value="${item.name || ''}" /></div>
              <div class="field"><label>tokens</label><input type="number" id="tariffTokens" value="${item.tokens}" /></div>
            </div>
            <div>
              <div class="field"><label>price_rub</label><input type="number" id="tariffRub" value="${item.price_rub}" /></div>
              <div class="field"><label>stars</label><input type="number" id="tariffStars" value="${item.stars}" /></div>
              <div class="field"><label>active</label><select id="tariffActive"><option value="1" ${item.is_active ? 'selected' : ''}>–í–∫–ª—é—á—ë–Ω</option><option value="0" ${!item.is_active ? 'selected' : ''}>–í—ã–∫–ª—é—á–µ–Ω</option></select></div>
            </div>
          </div>
          <button class="btn" id="saveTariffBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ</button>
          <p class="note">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —Ç–∞—Ä–∏—Ñ—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è sort_order, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫.</p>
          <ul class="drag-list" id="tariffDragList">${listHtml}</ul>
          <button class="btn alt" id="saveOrderBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫</button>
        `;

        document.getElementById('saveTariffBtn').onclick = async () => {
          try {
            const patch = {
              name: document.getElementById('tariffName').value,
              tokens: parseInt(document.getElementById('tariffTokens').value, 10) || 0,
              price_rub: parseInt(document.getElementById('tariffRub').value, 10) || 0,
              stars: parseInt(document.getElementById('tariffStars').value, 10) || 0,
              is_active: document.getElementById('tariffActive').value === '1',
            };
            const data = await apiFetch('/api/admin/tariffs/update', { id: item.id, patch });
            Object.assign(item, data.row || {});
            renderList();
            setStatus('–¢–∞—Ä–∏—Ñ –æ–±–Ω–æ–≤–ª—ë–Ω');
          } catch (e) { setStatus(e.message, false); }
        };

        const dragList = document.getElementById('tariffDragList');
        let dragged = null;
        [...dragList.querySelectorAll('.drag-item')].forEach(el => {
          el.ondragstart = () => { dragged = el; el.classList.add('dragging'); };
          el.ondragend = () => { el.classList.remove('dragging'); dragged = null; };
          el.ondragover = (ev) => { ev.preventDefault(); };
          el.ondrop = (ev) => {
            ev.preventDefault();
            if (!dragged || dragged === el) return;
            const list = [...dragList.children];
            const from = list.indexOf(dragged);
            const to = list.indexOf(el);
            if (from < to) dragList.insertBefore(dragged, el.nextSibling);
            else dragList.insertBefore(dragged, el);
          };
        });

        document.getElementById('saveOrderBtn').onclick = async () => {
          try {
            const ids = [...document.querySelectorAll('#tariffDragList .drag-item')].map(x => parseInt(x.dataset.id, 10));
            const payload = ids.map((id, idx) => ({ id, sort_order: idx }));
            await apiFetch('/api/admin/tariffs/reorder', { items: payload });
            setStatus('–ü–æ—Ä—è–¥–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
            await loadSection();
          } catch (e) { setStatus(e.message, false); }
        };
        return;
      }

      if (state.section === 'users') {
        const userId = item.telegram_id;
        editorEl.innerHTML = `
          <div class="grid">
            <div>
              <div class="field"><label>ID</label><input disabled value="${userId}" /></div>
              <div class="field"><label>Username</label><input disabled value="${item.username || '-'}" /></div>
              <div class="field"><label>–°–æ–∑–¥–∞–Ω</label><input disabled value="${fmtDate(item.created_at)}" /></div>
            </div>
            <div>
              <div class="field"><label>–û–±–Ω–æ–≤–ª—ë–Ω</label><input disabled value="${fmtDate(item.updated_at)}" /></div>
              <div class="field"><label>–°—Ç–∞—Ç—É—Å</label><input disabled value="${item.is_banned ? '–ó–∞–±–∞–Ω–µ–Ω' : '–ê–∫—Ç–∏–≤–µ–Ω'}" /></div>
              <div class="field"><label>–ü—Ä–∏—á–∏–Ω–∞ (–¥–ª—è –±–∞–Ω–∞)</label><input id="banReason" placeholder="–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª" /></div>
            </div>
          </div>
          <button class="btn danger" id="banBtn">–ó–∞–±–∞–Ω–∏—Ç—å</button>
          <button class="btn alt" id="unbanBtn">–†–∞–∑–±–∞–Ω–∏—Ç—å</button>
          <button class="btn alt" id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          <button class="btn danger" id="deleteDialogsBtn">–£–¥–∞–ª–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏</button>
        `;

        document.getElementById('banBtn').onclick = async () => {
          try {
            const reason = document.getElementById('banReason').value || '';
            await apiFetch('/api/admin/users/ban', { userId, reason });
            item.is_banned = true;
            renderList();
            setStatus('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω');
          } catch (e) { setStatus(e.message, false); }
        };

        document.getElementById('unbanBtn').onclick = async () => {
          try {
            await apiFetch('/api/admin/users/unban', { userId });
            item.is_banned = false;
            renderList();
            setStatus('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–∞–Ω–µ–Ω');
          } catch (e) { setStatus(e.message, false); }
        };

        document.getElementById('resetBtn').onclick = async () => {
          if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
          try {
            await apiFetch('/api/admin/users/reset-settings', { userId });
            setStatus('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã');
          } catch (e) { setStatus(e.message, false); }
        };

        document.getElementById('deleteDialogsBtn').onclick = async () => {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∏–∞–ª–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
          try {
            await apiFetch('/api/admin/users/delete-dialogs', { userId });
            setStatus('–î–∏–∞–ª–æ–≥–∏ —É–¥–∞–ª–µ–Ω—ã');
          } catch (e) { setStatus(e.message, false); }
        };
        return;
      }

      if (state.section === 'tokens') {
        const userId = item._key;
        const history = state.cache.tokenHistory || [];
        const table = renderTable([
          { label: '–î–∞—Ç–∞', key: 'created_at', render: r => fmtDate(r.created_at) },
          { label: '–°—É–º–º–∞', key: 'amount' },
          { label: 'action_key', key: 'action_key' },
          { label: '–û–ø–∏—Å–∞–Ω–∏–µ', key: 'description' },
          { label: '–ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ', key: 'balance_after' },
        ], history);

        editorEl.innerHTML = `
          <div class="grid">
            <div>
              <div class="field"><label>User ID</label><input id="tokUserId" value="${userId}" /></div>
              <div class="field"><label>Amount (+/-)</label><input id="tokAmount" type="number" value="100" /></div>
              <div class="field"><label>–ü—Ä–∏—á–∏–Ω–∞</label><input id="tokReason" placeholder="–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞" /></div>
              <button class="btn" id="tokApplyBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
            <div>
              <div class="field"><label>–§–∏–ª—å—Ç—Ä —Ç–∏–ø–∞</label><select id="tokType"><option value="all">–í—Å–µ</option><option value="credit">–ù–∞—á–∏—Å–ª–µ–Ω–∏—è</option><option value="debit">–°–ø–∏—Å–∞–Ω–∏—è</option></select></div>
              <div class="field"><label>From</label><input id="tokFrom" type="datetime-local" /></div>
              <div class="field"><label>To</label><input id="tokTo" type="datetime-local" /></div>
              <button class="btn alt" id="tokLoadBtn">–û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
            </div>
          </div>
          ${table}
        `;

        document.getElementById('tokApplyBtn').onclick = async () => {
          try {
            const uid = parseInt(document.getElementById('tokUserId').value, 10);
            const amount = parseInt(document.getElementById('tokAmount').value, 10);
            const reason = document.getElementById('tokReason').value || '';
            await apiFetch('/api/admin/tokens/adjust', { userId: uid, amount, reason });
            setStatus('–û–ø–µ—Ä–∞—Ü–∏—è —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
            await loadTokenHistory(uid);
            renderEditor();
          } catch (e) { setStatus(e.message, false); }
        };

        document.getElementById('tokLoadBtn').onclick = async () => {
          try {
            const uid = parseInt(document.getElementById('tokUserId').value, 10);
            await loadTokenHistory(uid, {
              type: document.getElementById('tokType').value,
              fromDate: document.getElementById('tokFrom').value || null,
              toDate: document.getElementById('tokTo').value || null,
            });
            renderEditor();
          } catch (e) { setStatus(e.message, false); }
        };
        return;
      }

      if (state.section === 'referrals') {
        const uid = parseInt(item._key, 10);
        const details = state.cache.userReferrals || [];
        editorEl.innerHTML = `
          <p class="note">referrer_id: <b>${uid}</b> ¬∑ count: <b>${item.referrals_count}</b> ¬∑ awarded: <b>${item.total_tokens_awarded}</b></p>
          <button class="btn alt" id="loadRefBtn">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
          ${renderTable([
            { label: 'ID', key: 'id' },
            { label: 'Referee', key: 'referee_id' },
            { label: 'Tokens', key: 'tokens_awarded' },
            { label: '–î–∞—Ç–∞', key: 'created_at', render: r => fmtDate(r.created_at) },
          ], details)}
        `;
        document.getElementById('loadRefBtn').onclick = async () => {
          try {
            const data = await apiFetch('/api/admin/referrals/user', { userId: uid, page: 0, limit: 100 });
            state.cache.userReferrals = data.items || [];
            renderEditor();
          } catch (e) { setStatus(e.message, false); }
        };
        return;
      }

      if (state.section === 'purchases') {
        const rows = state.cache.purchases || [];
        editorEl.innerHTML = `
          <div class="grid">
            <div class="field"><label>user_id</label><input id="pUser" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 12345" value="${state.cache.pFilterUser || ''}" /></div>
            <div class="field"><label>status</label><select id="pStatus"><option value="">–í—Å–µ</option><option value="completed">completed</option><option value="refunded">refunded</option></select></div>
            <div class="field"><label>from</label><input type="datetime-local" id="pFrom" /></div>
            <div class="field"><label>to</label><input type="datetime-local" id="pTo" /></div>
          </div>
          <button class="btn alt" id="loadPurchasesBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
          ${renderTable([
            { label: '–î–∞—Ç–∞', key: 'created_at', render: r => fmtDate(r.created_at) },
            { label: 'User', key: 'user_id' },
            { label: '–¢–∞—Ä–∏—Ñ', key: 'tariff_name' },
            { label: '–¢–æ–∫–µ–Ω—ã', key: 'tokens_credited' },
            { label: '‚≠ê', key: 'stars_paid' },
            { label: '–°—Ç–∞—Ç—É—Å', key: 'status' },
          ], rows)}
        `;

        document.getElementById('pStatus').value = state.cache.pFilterStatus || '';

        document.getElementById('loadPurchasesBtn').onclick = async () => {
          try {
            const payload = {
              page: 0,
              limit: 100,
              userId: document.getElementById('pUser').value || null,
              status: document.getElementById('pStatus').value || null,
              fromDate: document.getElementById('pFrom').value || null,
              toDate: document.getElementById('pTo').value || null,
            };
            state.cache.pFilterUser = payload.userId || '';
            state.cache.pFilterStatus = payload.status || '';
            const data = await apiFetch('/api/admin/purchases/list', payload);
            state.cache.purchases = data.items || [];
            renderEditor();
          } catch (e) { setStatus(e.message, false); }
        };
        return;
      }

      if (state.section === 'admins') {
        const rows = state.cache.admins || [];
        editorEl.innerHTML = `
          <div class="grid">
            <div class="field"><label>admin_id</label><input id="admId" type="number" /></div>
            <div class="field"><label>role</label><select id="admRole"><option value="moderator">moderator</option><option value="owner">owner</option></select></div>
          </div>
          <button class="btn" id="admSaveBtn">–î–æ–±–∞–≤–∏—Ç—å / –æ–±–Ω–æ–≤–∏—Ç—å</button>
          ${renderTable([
            { label: 'admin_id', key: 'admin_id' },
            { label: 'role', key: 'role' },
            { label: 'active', key: 'is_active' },
            { label: 'created', key: 'created_at', render: r => fmtDate(r.created_at) },
          ], rows)}
        `;
        document.getElementById('admSaveBtn').onclick = async () => {
          try {
            const adminId = parseInt(document.getElementById('admId').value, 10);
            const role = document.getElementById('admRole').value;
            await apiFetch('/api/admin/admins/upsert', { adminId, role, isActive: true });
            setStatus('–ê–¥–º–∏–Ω –æ–±–Ω–æ–≤–ª—ë–Ω');
            await loadSection();
          } catch (e) { setStatus(e.message, false); }
        };
        return;
      }

      if (state.section === 'audit') {
        const rows = state.cache.audit || [];
        editorEl.innerHTML = renderTable([
          { label: '–î–∞—Ç–∞', key: 'created_at', render: r => fmtDate(r.created_at) },
          { label: 'admin_id', key: 'admin_id' },
          { label: 'action', key: 'action' },
          { label: 'entity', key: 'entity' },
          { label: 'entity_id', key: 'entity_id' },
          { label: 'before', key: 'before_json', render: r => `<span class="mono">${JSON.stringify(r.before_json || {}).slice(0, 120)}</span>` },
          { label: 'after', key: 'after_json', render: r => `<span class="mono">${JSON.stringify(r.after_json || {}).slice(0, 120)}</span>` },
        ], rows);
      }
    };

    const loadTokenHistory = async (userId, extra = {}) => {
      const data = await apiFetch('/api/admin/tokens/history', {
        userId,
        page: 0,
        limit: 100,
        ...extra,
      });
      state.cache.tokenHistory = data.items || [];
    };

    const loadSection = async () => {
      if (!hasInitData) {
        editorEl.innerHTML = '<p class="note">–û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω–∫—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram (/admin). –ë–µ–∑ initData API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.</p>';
        listEl.innerHTML = '<div class="list-item">–ù–µ—Ç Telegram initData</div>';
        setStatus('–ù–µ—Ç Telegram –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞', false);
        return;
      }

      setStatus('–ó–∞–≥—Ä—É–∑–∫–∞...');
      const q = (queryInput.value || '').trim();
      state.query = q;
      state.items = [];
      state.selectedKey = null;

      try {
        if (state.section === 'content') {
          const data = await apiFetch('/api/admin/content/list');
          state.items = (data.items || []).filter(x => !q || x.key.includes(q)).map(x => ({ ...x, _key: x.key, _label: x.key }));
        } else if (state.section === 'prices') {
          const data = await apiFetch('/api/admin/prices/list');
          state.items = (data.items || []).filter(x => !q || x.action_key.includes(q)).map(x => ({ ...x, _key: x.action_key, _label: `${x.action_key} (${x.tokens})` }));
        } else if (state.section === 'tariffs') {
          const data = await apiFetch('/api/admin/tariffs/list');
          state.items = (data.items || []).filter(x => !q || `${x.name}`.toLowerCase().includes(q.toLowerCase())).map(x => ({ ...x, _key: String(x.id), _label: `#${x.id} ${x.name}` }));
        } else if (state.section === 'users') {
          const data = await apiFetch('/api/admin/users/list', { query: q, page: state.page, limit: state.limit });
          state.items = (data.users || []).map(x => ({
            ...x,
            _key: String(x.telegram_id),
            _label: `${x.telegram_id} ${x.username ? '@' + x.username : ''}${x.is_banned ? ' [BAN]' : ''}`,
          }));
        } else if (state.section === 'tokens') {
          const seedUser = q && /^\d+$/.test(q) ? parseInt(q, 10) : 0;
          const target = seedUser || 0;
          state.items = [{ _key: String(target), _label: target ? `user ${target}` : '–í—ã–±–µ—Ä–∏—Ç–µ user_id —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫' }];
          state.cache.tokenHistory = [];
          if (target) await loadTokenHistory(target);
        } else if (state.section === 'referrals') {
          const data = await apiFetch('/api/admin/referrals/top', { limit: 200 });
          state.items = (data.items || []).filter(x => !q || String(x.referrer_id).includes(q)).map(x => ({
            ...x,
            _key: String(x.referrer_id),
            _label: `referrer ${x.referrer_id} (${x.referrals_count})`,
          }));
          state.cache.userReferrals = [];
        } else if (state.section === 'purchases') {
          const data = await apiFetch('/api/admin/purchases/list', { page: 0, limit: 100 });
          state.cache.purchases = data.items || [];
          state.items = [{ _key: 'purchases', _label: `–ü–æ–∫—É–ø–∫–∏ (${state.cache.purchases.length})` }];
        } else if (state.section === 'admins') {
          const data = await apiFetch('/api/admin/admins/list');
          state.cache.admins = data.items || [];
          state.items = [{ _key: 'admins', _label: `–ê–¥–º–∏–Ω—ã (${state.cache.admins.length})` }];
        } else if (state.section === 'audit') {
          const data = await apiFetch('/api/admin/audit/list', { page: state.page, limit: state.limit });
          state.cache.audit = data.items || [];
          state.items = [{ _key: 'audit', _label: `–õ–æ–≥ (${state.cache.audit.length})` }];
        }

        state.selectedKey = state.items[0]?._key || null;
        renderList();
        renderEditor();
        setStatus('–ì–æ—Ç–æ–≤–æ');
      } catch (e) {
        listEl.innerHTML = `<div class="list-item">–û—à–∏–±–∫–∞: ${e.message}</div>`;
        editorEl.innerHTML = '<p class="note">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–∑–¥–µ–ª. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –∏ –¥–æ—Å—Ç—É–ø –∫ API.</p>';
        setStatus(e.message, false);
      }
    };

    queryInput.onkeydown = (ev) => {
      if (ev.key === 'Enter') loadSection();
    };

    prevBtn.onclick = async () => {
      state.page = Math.max(0, state.page - 1);
      await loadSection();
    };

    nextBtn.onclick = async () => {
      state.page += 1;
      await loadSection();
    };

    buildNav();
    selectSection('content');
  </script>
</body>
</html>
