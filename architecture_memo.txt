‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë              –ü–ê–ú–Ø–¢–ö–ê –ü–û –ê–†–•–ò–¢–ï–ö–¢–£–†–ï ‚Äî GPT Telegram Bot                     ‚ïë
‚ïë              –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∞: –º–∞—Ä—Ç 2026                                       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

1. –û–±—â–∞—è —Å—Ö–µ–º–∞
----------------
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Telegram ‚Üí Telegraf (src/index.js) ‚Üí middleware ‚Üí handlers
- –ë–æ—Ç –¥–µ—Ä–∂–∏—Ç:
  * Supabase ‚Äî –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (users, conversations, messages, prompts, content, tokens, settings)
  * Redis ‚Äî –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–ª–∞–≥–∏/—Å–æ—Å—Ç–æ—è–Ω–∏—è (active dialog, processing lock, prompt add, model, web search, etc.)
  * Express –≤ src/server.js ‚Äî –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç WebApp (/webapp, /gallery), –≥–∞–ª–µ—Ä–µ—é —à–∞–±–ª–æ–Ω–æ–≤ –∏ –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ API (/api/history, /api/templates, /api/template-select)
- –û—Å–Ω–æ–≤–Ω—ã–µ handlers: start, chat, callbacks, dialogs, nanoBanana, videoGen, profile; –≤—Å–µ –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ src/bot/handlers/index.js

2. –°–µ—Ä–≤–∏—Å—ã
------------
- services/supabase.js: CRUD –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü (bot_users, bot_conversations, bot_messages, bot_content, buttons, user_prompts, token_* , bot_user_settings). –¢–∞–∫–∂–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç sb –∫–∞–∫ supabase –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π.
- services/redis.js: –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ get/set/del –∫–ª—é—á–µ–π; –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è throttle, state-machine, active dialogs, user config.
- services/openai.js: –æ–±—ë—Ä—Ç–∫–∏ streamChat/webSearchChat/visual/voice/code interpreter, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º—Ç–æ–≤, retry logic, payload builder –∏ —Ä—É—Å—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞. –ù–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –∏ GPT Image 1.5 Edit + web search –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è.
- services/wavespeed.js: Nano Banana (nb1/nb2/SD5/GPT Image 1.5/Flux 2 Pro), Seedream, Seedance –∏ –ø—Ä–æ—á–∏–µ –≤–∏–¥–µ–æ–º–æ–¥–µ–ª–∏. –†–µ–∞–ª–∏–∑—É–µ—Ç pollResult –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL.
- services/tokens.js: —Ç–æ–∫–µ–Ω-—Å–∏—Å—Ç–µ–º–∞ (init balance, spend_tokens, credit_tokens, history). RPC –∫ Supabase (spend_tokens/credit_tokens) –∏ helper notEnoughMsg.
- services/userSettings.js: —Ö—Ä–∞–Ω–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ (—Ç–∞–±–ª–∏—Ü–∞ bot_user_settings); –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª—å.
- services/content(.js): CMS —á–µ—Ä–µ–∑ Supabase, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç—ã/–∫–Ω–æ–ø–∫–∏, –∫—ç—à–∏—Ä—É–µ—Ç 5 –º–∏–Ω—É—Ç.

3. –ö–ª—é—á–µ–≤—ã–µ —Ñ–∏—á–∏
----------------
- –¢–æ–∫–µ–Ω—ã: –∫–∞–∂–¥–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (—á–∞—Ç, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –≤–∏–¥–µ–æ, —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–∞) –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å; –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —Ç—Ä–∞—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –ö–æ–º–∞–Ω–¥—ã /balance –∏ /grant, /start –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–æ–Ω—É—Å –∏ –±–∞–ª–∞–Ω—Å, –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –Ω–∞—á–∏—Å–ª—è—Ç—å —Ç–æ–∫–µ–Ω—ã.
- –ú–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è: –∫–Ω–æ–ø–∫–∞ ¬´üë§ –ü—Ä–æ—Ñ–∏–ª—å¬ª –≤–µ–¥—ë—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏; inline-–∫–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
- –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏: –æ–±–Ω–æ–≤–ª—ë–Ω Nano Banana (template flow, GPT Image 1.5 Edit, Flux2), VideoGen –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (CMS-–∫–ª—é—á–∏, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏). –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤—Å–µ–≥–¥–∞ —Å—Ç—Ä–æ—è—Ç—Å—è —á–µ—Ä–µ–∑ async builder –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç CMS –∏ new buttons.
- –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
  * /webapp ‚Äî –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ (index.html).
  * /gallery ‚Äî —à–∞–±–ª–æ–Ω—ã –∏–∑ Supabase (`buttons`), –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º, lazy-load, —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –ø–æ–ª—É, POST /api/template-select –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —à–∞–±–ª–æ–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Telegram.
  * –í–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏ —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è—é—Ç initData (HMAC-SHA256), —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –ø–æ–¥–¥–µ–ª–∫–∏.
- –ö–æ–Ω—Ç–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç: `contentHelper.getBtn`/`cms()` –∏ —Ç–∞–±–ª–∏—Ü–∞ `bot_content` —É–ø—Ä–∞–≤–ª—è—é—Ç —Ç–µ–∫—Å—Ç–∞–º–∏, –∫–Ω–æ–ø–∫–∞–º–∏ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –º–µ–Ω—é.

4. Redis-—Ñ–ª–∞–≥–∏
---------------
- lock:{uid} ‚Äî –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (TTL 90—Å).
- conv:{uid} ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥.
- model:{uid}, wsearch:{uid} ‚Äî –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏/WebSearch.
- prompt_add_state:{uid} ‚Äî —Ä–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º—Ç–∞.
- template_* ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —à–∞–±–ª–æ–Ω–∞ (prompt, mode, name).
- nb:‚Ä¶ / vid:‚Ä¶ ‚Äî —à–∞–≥–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π/–≤–∏–¥–µ–æ.
- .gif: ‚Ä¶? (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –±—É–¥—É—â–∏—Ö —É–ø–æ–º–∏–Ω–∞–Ω–∏–π).

5. –ü–æ—Ç–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
-------------------
1. –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ auth middleware (ALLOWED_USERS).
2. chat.js –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ (locks, model, web search), –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Supabase –∏ –≤—ã–∑—ã–≤–∞–µ—Ç OpenAI –ª–∏–±–æ vision/voice/video —Å–µ—Ä–≤–∏—Å.
3. –°—Ç—Ä–∏–º–∏–Ω–≥ –æ–±–Ω–æ–≤–ª—è–µ—Ç Telegram —á–µ—Ä–µ–∑ safeEdit, throttle –∏ safeSendLong/Reply.
4. –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Supabase –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–∂–µ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è CMS).
5. –ü—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/–≤–∏–¥–µ–æ –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π —Å–Ω–∞—á–∞–ª–∞ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Ç–æ–∫–µ–Ω—ã, –∑–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã wavespeed.

6. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
------------------------
src/
‚îú‚îÄ‚îÄ index.js ‚Äî —ç–º–±–µ–¥–¥–∏–Ω–≥ –±–æ—Ç–∞ + Express + —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è setupHandlers
‚îú‚îÄ‚îÄ config/index.js ‚Äî .env –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ (APP_URL, WEBAPP_URL, PORT, ALLOWED_USERS)
‚îú‚îÄ‚îÄ server.js ‚Äî Express, –≤–∞–ª–∏–¥–∞—Ü–∏—è initData, API /history, /templates, /template-select, /gallery
‚îú‚îÄ‚îÄ services/ ‚Äî openai, supabase, redis, wavespeed, tokens, userSettings, content, contentHelper, botInstance
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ middleware/auth.js
‚îÇ   ‚îú‚îÄ‚îÄ handlers/ (start, chat, callbacks, dialogs, nanoBanana, videoGen, profile)
‚îÇ   ‚îî‚îÄ‚îÄ keyboards/ (main, models, dialogs, imageMenuKb, videoMenuKb, profileKb)
‚îî‚îÄ‚îÄ webapp/ ‚Äî static assets –¥–ª—è WebApp –∏ –≥–∞–ª–µ—Ä–µ–∏

7. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
----------------
- env: BOT_TOKEN, OPENAI_API_KEY, SUPABASE_URL, SUPABASE_KEY, REDIS_URL, WEBAPP_URL, APP_URL, PORT, ALLOWED_USERS, proxies
- CMS: —Ç–∞–±–ª–∏—Ü–∞ `bot_content` –∏ `buttons` —É–ø—Ä–∞–≤–ª—è—é—Ç —Ç–µ–∫—Å—Ç–∞–º–∏ –∏ –∫–ª–∞–≤–∏—à–∞–º–∏.
- Supabase: –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã token_* (config, prices, transactions, user_tokens) –∏ bot_user_settings.

8. –ü—Ä–∏–Ω—Ü–∏–ø—ã
-------------
- –≤—Å—ë, —á—Ç–æ –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ CMS (—Ç–µ–∫—Å—Ç—ã, –∫–Ω–æ–ø–∫–∏) ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `content`/`buttons`.
- Redis –¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Åient state, Supabase ‚Äî –¥–∞–Ω–Ω—ã–µ.
- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å—Ç—Ä–æ—è—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (`imageMenuKb`, `videoMenuKb`); –∏—Å–ø–æ–ª—å–∑—É—é—Ç `contentHelper.getBtn`.
- –¢–æ–∫–µ–Ω—ã –∑–∞—â–∏—â–∞—é—Ç —Ä–µ—Å—É—Ä—Å—ã: –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å–≤–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç `notEnoughMsg`, –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è.
- Profile –∏ –≥–∞–ª–µ—Ä–µ—è —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ WebApp –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã, –Ω–æ –æ–±–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–±—â–∏–π token+setting stack.

9. –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å —Å –º–æ–º–µ–Ω—Ç–∞ –ø—Ä–µ–∂–Ω–µ–π –∑–∞–º–µ—Ç–∫–∏
-----------------------------------------
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–æ–∫–µ–Ω-—Å–∏—Å—Ç–µ–º–∞ (tokens.js, RPC spend_tokens/credit_tokens), –∫–æ–º–∞–Ω–¥—ã `/balance` –∏ `/grant`, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–ø–∏—Å–∞–Ω–∏–∏.
- Nano Banana, GPT Image 1.5 Edit, Flux2 Pro ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤, –∫–∞–º–µ—Ä—ã, –Ω–æ–≤—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.
- VideoGen —Ä–∞—Å—à–∏—Ä–µ–Ω (–Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏, —Ç–æ–∫–µ–Ω—ã, —Å–æ–æ–±—â–µ–Ω–∏—è, CMS).
- –ì–∞–ª–µ—Ä–µ—è —à–∞–±–ª–æ–Ω–æ–≤ (`/gallery`, /api/template-select, profile flow) –∏ WebApp initData validation.
- –ü—Ä–æ—Ñ–∏–ª—å ‚Äî –±–∞–ª–∞–Ω—Å + –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, inline –∫–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
- CMS –∏ Redis –ø–µ—Ä–µ–ø–∏—Å–∞–Ω—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π (template state, token notes, more keys).
